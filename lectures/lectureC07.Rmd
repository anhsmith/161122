---
title: "C7 - Time Series and its Components"
date: "`r Sys.Date()`"
output:
  ioslides_presentation:
    mathjax: "https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-MML-AM_CHTML"
    highlight: tango
    widescreen: yes  
graphics: yes
---

```{r setup, echo=FALSE}
library(knitr)
library(ggplot2); theme_set(theme_bw(base_size=15))
library(patchwork)
opts_chunk$set(dev.args=list(bg='transparent'), comment="", echo=FALSE)
#print(knit_hooks$get('output'))
knit_hooks$set(output=function (x, options) {
#  cat("OPTIONS=", names(options), "\n")
  cache_path <- unlist(strsplit(options$cache.path, '/'))
#  cat("Cache_path length=", length(cache_path), "\n")
  out_format <- cache_path[length(cache_path)]
  if (out_format == "html") {
    knitr:::escape_html(x)
    x = paste(x, collapse = "\\n")
    sprintf("<div class=\"%s\"><pre class=\"knitr %s\">%s</pre></div>\\n", 
        'output', tolower(options$engine), x)
  } else {
    paste(c("\\begin{ROutput}",
            sub("\n$", "", x),
            "\\end{ROutput}",
            ""),
          collapse="\n")
  }
})
col_points <- "#7f577492"
col_dark   <- "#5f4354"
```

```{r global-options, include=FALSE}
knitr::opts_chunk$set( fig.width=10, fig.height=4.5,echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE)
```

```{r, echo=FALSE, message=FALSE}
library(tidyverse)
library(RBNZ)
library(janitor)
housing.M10 <- getSeries('M10')
housing <- housing.M10$data %>% tibble() %>% clean_names()  
```

## Learning Outcomes

- Time Series 

- Run chart

- Time Series Components

    - Trend 
    
    - Seasonality
    
    - Cycle
    
    - Irregularity

## Recap

- Simple linear model

- Inference and diagnostics

- Multivariable linear model

- Factors and interactions


# Time Series

## What do we see over time?

- Data obtained from observations collected sequentially over time are extremely common.

    - In business, we observe weekly interest rates, daily closing stock prices, monthly price indices, yearly sales figures, and so forth. 

    - In meteorology, we observe daily high and low temperatures, annual precipitation and drought indices, and hourly wind speeds. 

    - In agriculture, we record annual figures for crop and livestock production, soil erosion, and export sales. 

    - In the biological sciences, we observe the electrical activity of the heart at millisecond intervals. 

    - In ecology, we record the abundance of an animal species.

## Why do we study this? 

- The list of areas in which time series are studied is virtually endless. 

- The purpose of time series analysis is generally twofold: 

    - to understand or model the stochastic mechanism that gives rise to an observed series and
    
    - to predict or forecast the future values of a series based on the history of that series and, possibly, other related series or factors.
    
- Just like linear models - inference and prediction.

## Fundamental Concepts

- A **time series** is a series of data points indexed (or listed or graphed) in time order observed at successive equally spaced points in time. 

- A **time series**  can be written as $Y_1,Y_2,\ldots,Y_T$ which is an ordered sequence of random variables.

- The observations are made at times $t = 1,2,\ldots,T$.

- A somewhat unique feature of time series and their models is that we usually cannot assume that the observations arise independently from a common population. 

- Studying models that incorporate dependence is the key concept in time series analysis.

## Run Chart - Total value of NZ housing stock 

- A **run chart** is a **scatter-line plot** of time series observations over time. It is the basic visualisation tool for time series data.

```{r,echo=FALSE}
housing %>% ggplot(aes(x=date,y=m)) + geom_point(col='blue',alpha=0.3) + geom_line() +
  xlab('Time') + ylab('Total Value of Housing Stock') + ggtitle('Is housing market always prospering?')
```

## Run Chart - NZD/USD exchange rate

```{r,echo=FALSE}
exchangerate.B1 <- getSeries('B1')
exchangerate <- exchangerate.B1$data %>% tibble() %>% clean_names() 
exchangerate %>% select(date,united_states_dollar,chinese_renminbi) %>% drop_na() %>%
  ggplot(aes(x=date,y=united_states_dollar)) +  geom_line() + 
  xlab('Time') + ylab('NZD to USD Exchange Rate')+ ggtitle('Why IPhone is expensive in NZ?')
```

## Run Chart - NZ population

```{r,echo=FALSE}
population.M12 <- getSeries('M12')
population <- population.M12$data %>% tibble() %>% clean_names() 
population %>% select(date,number ) %>% drop_na() %>%
  ggplot(aes(x=date,y=number )) + geom_point(col='blue',alpha=0.4) + geom_line() + 
  xlab('Time') + ylab('NZ Population')+ ggtitle('How many kiwis in our country?')
```

## Run Chart - NZ export

```{r,echo=FALSE}
overseastrade.M8 <- getSeries('M8')
overseastrade <- overseastrade.M8$data %>% tibble() %>% clean_names() 
overseastrade %>% select(date,x_m) %>% drop_na() %>%
  ggplot(aes(x=date,y=x_m)) + geom_point(col='blue',alpha=0.4) + geom_line() + 
  xlab('Time') + ylab('Export Values (NZD million)')+ ggtitle('Goods sold by Kiwis to the world')
```

# Components of time series

## Components of time series

- Below is an extract from "Statistics for Business and Economics" by Prem S. Mann (1995), published by John Wiley, that gives a gentle introduction to the various components of a time series. 

- *A time series may contain one or more of the following four components: trend, seasonal, cyclical, and irregular (unobserved or remainder).* 

- These components, explained over the next few slides, describe how a time series behaves over time $t$.

# Trend

## Trend component

 - **Trend** is defined as the long-term movement (increase or decrease) in a time series. 
 
 - In other words, an increase or decrease in the values of a variable occurring over a
period of several years gives a trend. 

 - If the values of a time series do not change on average over time, then that time series has no trend.

 - A trend curve shows the long-run pattern in the growth or decline in a
time series that may represent a variable such as sales, inventories,
revenues, profits, employment, population, housing starts, gross national
product, consumer expenditure, investment, or interest rates, etc.

## Typical trend curves

```{r,echo=FALSE, fig.height=5.8}
set.seed(2020)
T<-24
freq <- 4
seasonalindex <- rep(scale(rdunif(freq,20),scale=FALSE),T/freq)
d <- data.frame(t = 1:T)
b <- 0.5
c <- 0.1
d$y1 <-  b * d$t + seasonalindex + rexp(T,1/2)
d$y2 <- -b * d$t + seasonalindex + rexp(T,1/2)
 
d$y3 <- d$y1 + c * (d$t)^2 
d$y4 <- d$y1 - c * (d$t-25)^2 

d$y5 <- -d$y1 - c * (d$t)^2 
  
d$y6 <- -d$y1 + c * (d$t-25)^2 
  
m1 <- lm(y1~t,data=d)
library(broom)
g1 <- augment(m1,d) %>% ggplot(aes(x=t,y=y1)) +geom_line(alpha=0.5) + geom_point(alpha=0.5) +
  geom_line(aes(y=.fitted,x=t),col='red')  + theme(axis.title.x = element_blank(),axis.title.y = element_blank())

m2 <- lm(y2~t,data=d)
g2 <- augment(m2,d) %>% ggplot(aes(x=t,y=y2)) +geom_line(alpha=0.5) + geom_point(alpha=0.5) +
  geom_line(aes(y=.fitted,x=t),col='red')  + theme(axis.title.x = element_blank(),axis.title.y = element_blank())


m3 <- lm(y3~t+I(t^2),data=d)
g3 <- augment(m3,d) %>% ggplot(aes(x=t,y=y3)) +geom_line(alpha=0.5) + geom_point(alpha=0.5) +
  geom_line(aes(y=.fitted,x=t),col='red')  + theme(axis.title.x = element_blank(),axis.title.y = element_blank())


m4 <- lm(y4~t+I(t^2),data=d)
g4 <- augment(m4,d) %>% ggplot(aes(x=t,y=y4)) +geom_line(alpha=0.5) + geom_point(alpha=0.5) +
  geom_line(aes(y=.fitted,x=t),col='red') + theme(axis.title.x = element_blank(),axis.title.y = element_blank())

m5 <- lm(y5~t+I(t^2),data=d)
g5 <- augment(m5,d) %>% ggplot(aes(x=t,y=y5)) +geom_line(alpha=0.5) + geom_point(alpha=0.5) +
  geom_line(aes(y=.fitted,x=t),col='red') + theme(axis.title.x = element_blank(),axis.title.y = element_blank())

m6 <- lm(y6~t+I(t^2),data=d)
g6 <- augment(m6,d) %>% ggplot(aes(x=t,y=y6)) +geom_line(alpha=0.5) + geom_point(alpha=0.5) +
  geom_line(aes(y=.fitted,x=t),col='red') + theme(axis.title.x = element_blank(),axis.title.y = element_blank())

(g1 + g2)/(g3 + g4)/(g5 + g6)

```

## Typical trend curves{.smaller}

  - Top-left figure shows the linear trend for a time series that grows
continuously,

  - Top-right figure shows the linear trend for a time series that declines
continuously,

  - Middle-left figure shows the (nonlinear) trend curve for a time series for which the increase in the value of the variable occurs at an increasing rate for each successive period,

  - Middle-right figure gives the (nonlinear) trend curve for a time series that grows at an increasing rate in the beginning but eventually reaches a maximum point where there is very little increase in the value of the variable.
  
  - Bottom-left figure shows the nonlinear trend pattern for a time series that has a slow decline in the initial periods but very rapid decline in later periods.

  - Bottom-right figure exhibits the nonlinear trend pattern for a time series that has a rapid decline in the initial periods but a very slow decline in later periods.

## Trend

The long-term movement in a time series may occur due to many factors such as 

  -   changes in tastes and preferences of consumers, 
  
  -   technological changes, 
  
  -   demographic changes (changes in population and structure of population), 

  -   social and cultural changes.

## Trend

- The trend analysis of historical data helps evaluate past policies. 

- For example, the trend patterns of variables such as sales, revenues, and profits of a company for the past decade can tell us how successful the managerial policies of this period have been.

- Knowing the trend of a time series is useful for making decisions about the
future values of business and economic activities. 

- An important question is how to extract the trend component from a time series.

    - We can use `lm()` i.e. linear models to extract various trends from time series.
    
    - We can also use `geom_smooth()` to extract a smoothed trend.

## Linear trend in NZ population

```{r,echo=FALSE}
population %>% select(date,number ) %>% drop_na() %>%
  ggplot(aes(x=date,y=number )) + geom_point(col='red',alpha=0.4) + geom_line() + geom_smooth(method='lm') +
  xlab('Time') + ylab('NZ Population')+ ggtitle('How many kiwis in our country?')
```


## Smoothed trend in NZ population

```{r,echo=FALSE}
population %>% select(date,number ) %>% drop_na() %>%
  ggplot(aes(x=date,y=number )) + geom_point(col='red',alpha=0.4) + geom_line() + geom_smooth() +
  xlab('Time') + ylab('NZ Population')+ ggtitle('How many kiwis in our country?')
```


## Linear trend in total value of NZ housing stock

```{r,echo=FALSE}
housing %>% ggplot(aes(x=date,y=m)) + geom_point(col='blue',alpha=0.3) + geom_line() + geom_smooth(method='lm')+
  xlab('Time') + ylab('Total Value of Housing Stock') + ggtitle('Is housing market always prospering?')
```

## Quadratic or Smoothed?

```{r,echo=FALSE}
library(broom)
housing.ts <- housing %>% mutate(time=1:n())
hpi.qm <- lm(m~time+I(time^2), data=housing.ts)
augment(hpi.qm,housing.ts) %>% ggplot(aes(x=date,y=m)) + geom_point(col='red',alpha=0.2) + geom_line() +
  geom_smooth(alpha=0.2) + geom_line(aes(y=.fitted),col='green')+
  xlab('Time') + ylab('Total Value of Housing Stock') + ggtitle('Is housing market always prospering?')
```

# Seasonality

## Seasonal component 

- Seasonal variations in a time series are defined as the movement that occurs in a time series periodically within a fixed time period. 

- Many business activities, such as production and sales, exhibit seasonal patterns over different time periods (e.g. months or quarters) of a year. 

- These seasonal variations may occur due to weather, holidays, or institutional factors. For example:

    - Sales of ski equipment are very high during winter and almost nonexistent during other seasons.
    - Sales at department stores around Christmas holidays are much higher than during other times of the year.
    - Power bills are expected to be higher during winter than in other seasons.

## Seasonality 

- Such fluctuations are repeated every year, although not in an identical fashion. 

- Nevertheless, with good data and appropriate statistical analysis, many seasonal variations in business and economic activities can be predicted.

- An important question is how to extract the seasonal component from a time series.

    - We can use linear models with factors to extract seasonalities from time series
    
    - Need to address trend together!
    
    - The variability of seasonalities may increase over time. Take a log to fix it.
    
## Seasonalities in NZ export between 1990 to 2000

```{r,echo=FALSE}
library(lubridate)
overseastrade.ts <- overseastrade %>% select(date,x_m) %>% drop_na() %>%  mutate(time=1:n()) %>% mutate(quarter=factor(quarter(date))) %>%  filter(date < ymd('2000-01-01'))
rts.lm.q <- lm(x_m~time+quarter,data=overseastrade.ts)
augment(rts.lm.q,overseastrade.ts) %>% ggplot(aes(x=date,y=x_m)) + geom_point(col='red',alpha=0.3) + geom_line() + geom_line(aes(y=.fitted),col='blue')+
  xlab('Time') + ylab('Export Values (NZD million)')+ ggtitle('Goods sold by Kiwis to the world')
```
    
# Irregularity

## Irregular component

- Irregular fluctuations are random or chance variations in a time series. 

- They are the residuals after trend, *cyclical*, and seasonal components have been removed from the time series data.

- Such movements may occur due to unpredictable events such as strikes, wars, earthquakes, hurricanes, floods, etc. 

- These events can significantly affect the production of goods and services and other economic and business activities.

- For example, floods usually cause a reduction in agricultural and industrial production. 

## Irregularity or residuals?

- Due to the nature of irregular variations, they are impossible to predict.

- They are similar to residuals after removing trend and seasonality from the time series regression!

- However, we have observed that the residuals in time series regression look peculiar. 

- They are not independent! 

- Something evil is hidden in the irregular component.

## Residuals of NZ housing

```{r,echo=FALSE}
augment(hpi.qm,housing.ts) %>% ggplot(aes(x=date,y=m)) + geom_point(col='red',alpha=0.2) + geom_line() +
  geom_smooth(alpha=0.2) + geom_hline(yintercept=0) + geom_line(aes(y=.resid),col='green') +
  xlab('Time') + ylab('Total Value of Housing Stock') + ggtitle('Is housing market always prospering?')
```


# Cycle

## Cyclical component

- Usually a time series exhibits fluctuations around the trend line. 

- That is, for some periods the actual time series curve is above the trend line and for other periods it is below the trend line. 

- The non-periodic fluctuations in time series data around the trend line are referred to as the cyclical component or cyclical fluctuations. 

- Note that the cyclical fluctuations do not last for any specific amount of time. They may last from more than one year to a period of 20 years.

- Recession, depression, recovery and boom cause variations in time series
data, and these variations make up business cycles. 

- These business cycles fluctuations are called the cyclical component or fluctuations.

## Cycle versus Seasonality

- A seasonal pattern exists when a series is influenced by seasonal factors
(e.g., the quarter of the year, the month, or day of the week). 

    - Seasonality is always of a fixed and known period no larger than one year.

- A cyclic pattern exists when data exhibit rises and falls that are not of fixed period. 

    - The duration of these fluctuations is usually of at least 2 years.

- The two are very different: 

    - If the fluctuations are not of fixed period then they are cyclic; 
    
    - if the period is unchanging and associated with some aspect of the calendar, then the pattern is seasonal.

## What can I do with the cyclic component?

- This can be the component that has the most to offer in terms of understanding where the series may be headed in the short/medium term.

- The length and amplitude of previous cycles may forecast the next turning point in the current cycle.

- "**20/20 hindsight**" can often explain cyclic movements around the trend line in terms of past events or other variables

- By looking at those variables or events in the present, we may be able to predict the likely future direction of the cycle movement.

- **The Theory of Mean Reversion.**

## Business Cycles

- There are a variety of economic indicators, such as interest rates, unemployment rates, migration rates, etc.

- It is possible that some of these, or an index summarising them, may be useful in predicting the cycle factor in a time series.

- This could be done in regression analysis with the cycle factor (an estimate of the position in the cycle) as a dependent variable. 

- Forecasting would involve predicting the rest of the cycle (not sure we're making progress here ...) using the index as the independent variable in a regression model.

- In this course, we de-emphasize the cyclical component as we may lump it together with the residuals.

## Cycle of NZ housing?

```{r,echo=FALSE}
augment(hpi.qm,housing.ts) %>% ggplot(aes(x=date,y=m)) + geom_point(col='red',alpha=0.2) + geom_line() +
  geom_smooth(alpha=0.2) + geom_hline(yintercept=0) + geom_line(aes(y=.resid),col='green') +
  xlab('Time') + ylab('Total Value of Housing Stock') + ggtitle('Is housing market always prospering?')
```

## Assemble or decompose? 

- The components can be integrated via addition:
$Y_t=\mbox{Trend}_t+\mbox{Cycle}_t+\mbox{Seasonality}_t+\mbox{Irregularity}_t$

- The components can also be integrated via multiplication:
$Y_t=\mbox{Trend}_t\times\mbox{Cycle}_t\times\mbox{Seasonality}_t\times\mbox{Irregularity}_t$

- The above two are equivalent by calling a log transformation

- We merely have $Y_t$, not any one from components. 

- Linear models is one possible choice to do **time series decomposition**. 

- More will be covered in future statistics papers. 

## Summary

- Time series and its visualisation

- Four components in time series